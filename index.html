<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸ç‰¹å‹™ï¼šæ‘©æ–¯å¯†ç¢¼</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            /* å¥—ç”¨æ–°å­—é«”ï¼šå„ªå…ˆä½¿ç”¨ Fredokaï¼Œä¸­æ–‡è‡ªå‹•é€€å›åˆ° Noto Sans TC */
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #2c3e50; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #ecf0f1;
        }

        h1 {
            color: #f1c40f; 
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 700; 
            letter-spacing: 1px;
        }

        /* ç¢ºä¿è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•ä¹Ÿåƒåˆ°å¯æ„›å­—é«” */
        input, button {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
        }

        .game-info {
            background-color: #34495e; 
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #e74c3c; 
            margin-bottom: 20px;
            max-width: 900px;
            line-height: 1.6;
            color: #ecf0f1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .mission-brief {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #7f8c8d;
            display: flex; 
            gap: 15px;
        }
        
        .mission-icon {
            flex-shrink: 0; 
            font-size: 1.2em;
            padding-top: 5px;
        }

        .mission-content {
            flex-grow: 1;
        }

        .mission-text {
            margin-top: 5px; 
            display: block;
        }
        
        .instruction-list {
            margin-top: 5px;
            margin-bottom: 0;
            padding-left: 24px; 
        }
        .instruction-list li {
            margin-bottom: 8px;
        }
        
        .legend {
            margin-top: 10px;
            display: flex;
            gap: 30px; 
            font-weight: bold;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: #2c3e50;
            justify-content: center; 
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        /* å·¦å´æ«ƒå­å€åŸŸ */
        .cabinet-section {
            flex: 1.5;
            min-width: 340px;
            background-color: #95a5a6; 
            padding: 15px;
            border-radius: 15px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 5px 5px 20px rgba(0,0,0,0.4);
            border: 12px solid #2c3e50;
            overflow-x: auto;
        }

        .cabinet-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            gap: 10px;
            min-width: 700px; 
        }

        .cell {
            background-color: #bdc3c7;
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            aspect-ratio: 0.85;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px;
            position: relative;
            box-shadow: inset 1px 1px 3px rgba(255,255,255,0.5), inset -2px -2px 5px rgba(0,0,0,0.1);
        }

        .cell.decoration {
            justify-content: center;
            align-items: center;
            padding: 0;
        }
        
        .cell.empty {
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .decoration-icon {
            width: 70%;
            height: 70%;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
            transition: transform 0.3s;
        }
        .decoration-icon:hover { transform: scale(1.1) rotate(5deg); }

        /* æ ¼å­å…§çš„å­—æ¯è¼¸å…¥æ¡† */
        .letter-board {
            width: 80%;
            height: 25px;
            background-color: #fff;
            border: 2px solid #95a5a6;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            font-weight: bold; 
            text-transform: uppercase;
            color: #2c3e50;
            outline: none;
            transition: color 0.2s, border-color 0.2s;
        }
        .letter-board:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }

        /* æ«ƒå­å…§çš„ç¬¦è™Ÿé¡¯ç¤º (ä¸­é–“) */
        .symbol-board {
            display: flex;
            gap: 3px; 
            justify-content: center;
            align-items: center;
            height: 24px;
            width: 100%;
        }

        /* é€šç”¨ç¬¦è™Ÿæ¨£å¼ */
        .symbol-placeholder {
            width: 16px;
            height: 6px;
            background-color: #95a5a6;
            border-radius: 2px;
            cursor: pointer;
            align-self: center;
        }

        .morse-dot {
            width: 10px; height: 10px; background-color: #3498db; border-radius: 50%;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .morse-dash {
            width: 22px; height: 10px; background-color: #e74c3c; border-radius: 5px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .balls-container {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .balls-container.wrap-grid {
            max-width: 55px; 
        }

        .ball {
            width: 22px;
            height: 22px;
            background-color: #f1c40f;
            border: 1px solid #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            color: #2c3e50;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
            box-shadow: 1px 2px 3px rgba(0,0,0,0.2);
            user-select: none;
        }
        .ball:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .ball:active { transform: scale(0.95); }

        /* å³å´å€åŸŸ */
        .sidebar {
            flex: 1; 
            min-width: 450px; 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .morse-chart, .answer-section {
            background-color: #ecf0f1; 
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #2c3e50;
        }

        .morse-chart h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #444;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .answer-section h2 {
            color: #444;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .morse-table {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
            font-size: 14px;
        }

        .morse-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
        }
        
        .morse-separator {
            grid-column: 1 / -1;
            height: 2px;
            background-color: #3498db;
            margin: 10px 0;
            position: relative;
        }
        .morse-separator::after {
            content: "é‘°åŒ™ç·¨è™Ÿå€";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #ecf0f1;
            padding: 0 10px;
            color: #3498db;
            font-weight: bold;
            font-size: 12px;
        }

        .unlock-grid {
            display: grid;
            grid-template-columns: 60px 1fr 80px 1.5fr; 
            gap: 10px;
            align-items: center;
        }

        .unlock-header {
            font-weight: bold;
            text-align: center;
            background-color: #bdc3c7;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            color: #2c3e50;
        }

        .unlock-row-label {
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
        }

        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .unlock-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #95a5a6;
            border-radius: 5px;
            font-size: 1rem;
            text-align: center;
            box-sizing: border-box;
            background-color: #fff;
            color: #2c3e50;
        }
        .unlock-input:focus {
            border-color: #e67e22;
            outline: none;
            box-shadow: 0 0 5px rgba(230, 126, 34, 0.5);
        }
        .unlock-input::placeholder {
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .sidebar-interactive-board {
            background-color: #34495e;
            border-radius: 5px;
            padding: 8px;
            min-height: 34px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px; 
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        
        .morse-visual { display: flex; gap: 2px; align-items: center; }
        .table-dot { width: 6px; height: 6px; background-color: #3498db; border-radius: 50%; }
        .table-dash { width: 14px; height: 6px; background-color: #e74c3c; border-radius: 3px; }

        .final-challenge {
            margin-top: 20px;
            padding: 15px;
            background-color: #fcf3cf;
            border: 2px solid #f1c40f;
            border-radius: 8px;
            text-align: center;
            color: #7f8c8d;
        }
        .final-challenge h3 {
            margin-top: 0;
            color: #d35400;
            font-size: 1.1rem;
        }
        .final-challenge p {
            margin: 10px 0;
            font-size: 0.95rem;
            color: #2c3e50;
            line-height: 1.5;
        }
        .final-key-input {
            font-size: 1.5rem;
            padding: 10px;
            width: 100px;
            text-align: center;
            border: 3px solid #d35400;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #d35400;
        }

        .final-answer {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            background-color: #27ae60;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 #219150;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .submit-btn:hover { 
            background-color: #2ecc71; 
        }
        .submit-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #219150;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            width: 85%;
            max-width: 600px;
            text-align: center;
            position: relative;
            animation: slideDown 0.4s ease-out;
            color: #333;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
            transition: color 0.2s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #e74c3c;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .modal-text {
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .success-style { color: #27ae60; }
        .error-style { color: #c0392b; }

        @media (max-width: 900px) {
            .game-container { flexDirection: column; align-items: center; }
            .sidebar { width: 100%; min-width: auto; }
            .cabinet-section { width: 100%; }
        }
    </style>
</head>
<body>

<h1>æ•¸å­¸ç‰¹å‹™ï¼šæ‘©æ–¯å¯†ç¢¼</h1>

<div class="game-info">
    <div class="mission-brief">
        <div class="mission-icon">ğŸ•µï¸â€â™‚ï¸</div>
        <div class="mission-content">
            <img src="Beginning.png" style="width: 100%; max-width: 500px; display: block; margin: 0 auto 10px auto; border-radius: 5px;" alt="ä»»å‹™é–‹å§‹">
            
            <strong>ä»»å‹™ä»£è™Ÿï¼šè³ªæ•¸èˆ‡åˆæ•¸</strong>
            <div class="mission-text">
                ç‰¹å‹™ä½ å¥½ï¼æˆ‘å€‘å·²æˆåŠŸæ½›å…¥å£è›‹çš„è±ªå®…ã€‚æ“šæƒ…å ±é¡¯ç¤ºï¼Œä»–æŠŠæ¶ä¾†çš„ç å¯¶æ”¾åœ¨ç‰¹è£½çš„ 30 æ ¼å¯†ç¢¼ä¿éšªç®±è£¡ï¼Œä¸¦ç”¨ä¸€æŠŠé‘°åŒ™é–ä¸Šæœ€å¤–å±¤çš„ç»ç’ƒæ«ƒã€‚<br>
                æ¡Œä¸Šæœ‰ç·¨è™Ÿ 0ï½9 çš„ 10 æŠŠé‘°åŒ™ä»¥åŠä¸€å¼µæ‘©æ–¯å¯†ç¢¼è¡¨ï¼Œè«‹ä½ æ ¹æ“šæ“ä½œæŒ‡å¼•æ‰¾å‡ºæ­£ç¢ºç·¨è™Ÿçš„é‘°åŒ™ã€‚<br>
                <span style="color: #e74c3c; font-weight: bold;">âš ï¸âš ï¸âš ï¸ è­¦å‘Šï¼šå¦‚æœè§£é–å¤±æ•—ï¼Œå°‡æœƒè§¸ç™¼è­¦å ±å¼•ä¾†å®ˆè¡›ï¼Œä»»å‹™å°±æœƒå¤±æ•—ï¼Œä½ ä¹Ÿæœƒè¢«å¯Œç¿æŠ“ä½ï¼ç¥ä½ å¥½é‹ï¼âš ï¸âš ï¸âš ï¸</span>
            </div>
        </div>
    </div>
    
    <strong>æ“ä½œæŒ‡å¼•ï¼š</strong>
    <ol class="instruction-list">
        <li>å…ˆåˆ¤æ–·å·¦å´ä¿éšªæ«ƒä¸Šé»ƒçƒå…§çš„æ•¸å­—æ˜¯è³ªæ•¸æˆ–æ˜¯åˆæ•¸ï¼Œé»æ“Šé»ƒçƒä¾†è¨˜éŒ„ç¬¦è™Ÿï¼ˆè³ª <div class="morse-dash" style="width: 14px; height: 6px; display: inline-block; vertical-align: middle; margin: 0 1px; box-shadow:none; cursor: default;"></div>ï¼åˆ <div class="morse-dot" style="width: 8px; height: 8px; display: inline-block; vertical-align: middle; margin: 0 1px; box-shadow:none; cursor: default;"></div>ï¼‰ã€‚</li>
        <li>å°ç…§æ‘©æ–¯å¯†ç¢¼è¡¨ï¼Œåœ¨ä¿éšªæ«ƒä¸Šçš„ç™½è‰²é¢æ¿ä¸­è¼¸å…¥å°æ‡‰çš„è‹±æ–‡å­—æ¯ã€‚è‹¥å­—æ¯é¡¯ç¤º<span style="color: #e74c3c; font-weight: bold;">ç´…è‰²</span>ï¼Œè¡¨ç¤ºä½ çš„æ•¸å­—åˆ¤æ–·éŒ¯èª¤æˆ–æ˜¯å­—æ¯è½‰æ›éŒ¯èª¤ã€‚</li>
        <li>åœ¨è§£é–é¢æ¿ä¸Šå°‡å­—æ¯æ‹¼å‡ºçš„å–®å­—è½‰æ›æˆæ•¸å­—ä¸¦è¼¸å…¥ï¼Œå†æ¬¡åˆ¤æ–·é€™äº”å€‹æ•¸å­—çš„è³ªï¼åˆæ•¸ï¼Œæ‰¾å‡ºæ­£ç¢ºé‘°åŒ™ï¼</li>
    </ol>
    
    <div class="legend">
        <div class="legend-item">
            <span>è³ªæ•¸ (Prime)</span>
            <div class="morse-dash"></div>
        </div>
        <div class="legend-item">
            <span>åˆæ•¸ (Composite)</span>
            <div class="morse-dot"></div>
        </div>
    </div>
</div>

<div class="game-container">
    <div class="cabinet-section">
        <div class="cabinet-grid" id="cabinetGrid">
            </div>
    </div>

    <div class="sidebar">
        <div class="morse-chart">
            <h2>
                æ‘©æ–¯å¯†ç¢¼è¡¨
                <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 8px; font-weight: normal;">
                    <div style="display: flex; align-items: center; gap: 2px;">
                        è³ª<div class="morse-dash" style="width: 14px; height: 6px; display: inline-block; margin: 0; box-shadow:none; cursor: default;"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 2px;">
                        åˆ<div class="morse-dot" style="width: 8px; height: 8px; display: inline-block; margin: 0; box-shadow:none; cursor: default;"></div>
                    </div>
                </div>
            </h2>
            <div class="morse-table" id="morseTable">
                </div>
        </div>

        <div class="answer-section">
            <h2>è§£é–é¢æ¿</h2>
            <div class="unlock-grid">
                <div class="unlock-header">å±¤æ•¸</div>
                <div class="unlock-header">å­—æ¯</div>
                <div class="unlock-header">æ•¸å­—</div>
                <div class="unlock-header">
                    <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 1px;">
                        åˆ¤æ–·è³ª <div class="morse-dash" style="width: 14px; height: 6px; display: inline-block; vertical-align: middle; margin: 0 1px; box-shadow:none; cursor: default;"></div> ï¼åˆæ•¸ <div class="morse-dot" style="width: 8px; height: 8px; display: inline-block; vertical-align: middle; margin: 0 1px; box-shadow:none; cursor: default;"></div>
                    </div>
                </div>

                <div class="unlock-row-label">ç¬¬ä¸€å±¤</div>
                <input type="text" class="unlock-input" id="input-word-0" placeholder="">
                <input type="number" class="unlock-input" id="input-num-0" placeholder="è¼¸å…¥æ•¸å­—">
                <div class="sidebar-interactive-board" id="sidebar-board-0"></div>

                <div class="unlock-row-label">ç¬¬äºŒå±¤</div>
                <input type="text" class="unlock-input" id="input-word-1" placeholder="">
                <input type="number" class="unlock-input" id="input-num-1" placeholder="è¼¸å…¥æ•¸å­—">
                <div class="sidebar-interactive-board" id="sidebar-board-1"></div>

                <div class="unlock-row-label">ç¬¬ä¸‰å±¤</div>
                <input type="text" class="unlock-input" id="input-word-2" placeholder="">
                <input type="number" class="unlock-input" id="input-num-2" placeholder="è¼¸å…¥æ•¸å­—">
                <div class="sidebar-interactive-board" id="sidebar-board-2"></div>

                <div class="unlock-row-label">ç¬¬å››å±¤</div>
                <input type="text" class="unlock-input" id="input-word-3" placeholder="">
                <input type="number" class="unlock-input" id="input-num-3" placeholder="è¼¸å…¥æ•¸å­—">
                <div class="sidebar-interactive-board" id="sidebar-board-3"></div>

                <div class="unlock-row-label">ç¬¬äº”å±¤</div>
                <input type="text" class="unlock-input" id="input-word-4" placeholder="">
                <input type="number" class="unlock-input" id="input-num-4" placeholder="è¼¸å…¥æ•¸å­—">
                <div class="sidebar-interactive-board" id="sidebar-board-4"></div>
            </div>

            <div class="final-challenge">
                <h3>ğŸ”‘</h3>
                <p>
                    åˆ¤æ–·ä¸Šæ–¹äº”å€‹ã€Œç­”æ¡ˆæ•¸å­—ã€çš„è³ªï¼åˆæ•¸å¾Œï¼Œ<br>
                    å°‡é€™äº”å€‹ç¬¦è™Ÿçµ„æˆæ–°çš„ä¸€çµ„æ‘©æ–¯å¯†ç¢¼ï¼Œ<br>
                    æŸ¥æ‘©æ–¯å¯†ç¢¼è¡¨æ‰¾å‡ºå°æ‡‰çš„æ­£ç¢ºé‘°åŒ™ç·¨è™Ÿã€‚
                </p>
                <input type="number" class="final-key-input" id="final-key-input" placeholder="?">
            </div>

            <div class="final-answer">
                <button class="submit-btn" onclick="checkAnswer()">é–‹å•Ÿç»ç’ƒæ«ƒ</button>
            </div>
        </div>
    </div>
</div>

<div id="resultModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modalMessage"></div>
    </div>
</div>

<audio id="bgm" loop>
    <source src="bgm.m4a" type="audio/mp4">
</audio>

<button id="musicBtn" onclick="toggleMusic()" style="
    position: fixed; 
    bottom: 20px; 
    right: 20px; 
    z-index: 2000; 
    background-color: #34495e; 
    color: white; 
    border: 2px solid #f1c40f; 
    border-radius: 50px; 
    padding: 10px 20px; 
    font-size: 16px; 
    cursor: pointer; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    font-family: 'Fredoka', 'Noto Sans TC', sans-serif; /* æŒ‰éˆ•ä¹Ÿå¥—ç”¨å¯æ„›å­—é«” */
    transition: all 0.3s;
">
    ğŸ”‡ æ’­æ”¾éŸ³æ¨‚
</button>

<script>
    // Music Controls
    const bgm = document.getElementById('bgm');
    const musicBtn = document.getElementById('musicBtn');
    let isPlaying = false;

    // è¨­å®šéŸ³é‡ (0.0 åˆ° 1.0ï¼Œå»ºè­° 0.3 ä¸è¦å¤ªåµ)
    bgm.volume = 0.3;

    function toggleMusic() {
        if (isPlaying) {
            bgm.pause();
            musicBtn.innerHTML = "ğŸ”‡ æ’­æ”¾éŸ³æ¨‚";
            musicBtn.style.backgroundColor = "#34495e"; // æš«åœæ™‚è®Šå›æ·±è‰²
        } else {
            bgm.play().then(() => {
                // æ’­æ”¾æˆåŠŸ
                musicBtn.innerHTML = "ğŸ”Š éŸ³æ¨‚é–‹å•Ÿ";
                musicBtn.style.backgroundColor = "#27ae60"; // æ’­æ”¾æ™‚è®Šæˆç¶ è‰²
            }).catch(error => {
                console.log("æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é˜»æ“‹: " + error);
            });
        }
        isPlaying = !isPlaying;
    }

    // Game Logic
    const morseCodeMap = {
        'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
        'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
        'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
        'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
        'Y': '-.--', 'Z': '--..',
        '0': '-----', '1': '.----', '2': '..---', '3': '...--', '4': '....-',
        '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.'
    };

    const symbolToLetterMap = Object.fromEntries(Object.entries(morseCodeMap).map(a => a.reverse()));

    const cabinetDataRaw = [
        { balls: [27, 16, 43, 8] },      // F
        { balls: [97, 13, 47] },         // O
        { balls: [34, 29, 51] },         // R
        { balls: [53] },                 // T
        { balls: [31, 28, 2, 19] },      // Y
        { balls: [], type: 'safe' },     

        { balls: [21] },                 // E
        { balls: [96, 69] },             // I
        { balls: [71, 37, 99] },         // G
        { balls: [81, 14, 64, 77] },     // H
        { balls: [59] },                 // T
        { balls: [73, 39, 5, 41] },      // Y

        { balls: [57] },                 // E
        { balls: [24, 23, 40, 52] },     // L
        { balls: [91] },                 // E
        { balls: [38, 44, 25, 17] },     // V
        { balls: [10] },                 // E
        { balls: [89, 46] },             // N

        { balls: [83] },                 // T
        { balls: [26, 33, 18, 6] },      // H
        { balls: [75, 61, 9] },          // R
        { balls: [95] },                 // E
        { balls: [87] },                 // E
        { balls: [], type: 'safe' },     

        { balls: [65, 56, 35] },         // S
        { balls: [49] },                 // E
        { balls: [55, 42, 15, 79] },     // V
        { balls: [72] },                 // E
        { balls: [67, 93] },             // N
        { balls: [], type: 'safe' },     
    ];

    const correctAnswers = [40, 80, 11, 3, 7];
    const correctFinalKey = 2;

    // State tracking
    const ballStates = {}; // Left cabinet states
    const sidebarStates = {}; // Right sidebar states (independent)

    function initGame() {
        createCabinetGrid();
        createMorseTable();
        initSidebarInteractiveBoards();
    }

    function isPrime(num) {
        if (num <= 1) return false;
        for (let i = 2; i <= Math.sqrt(num); i++) {
            if (num % i === 0) return false;
        }
        return true;
    }

    function getSymbol(num) {
        return isPrime(num) ? '-' : '.';
    }

    function playClickSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine'; // Sine is clean, good for 'crisp' high ticks
        osc.frequency.setValueAtTime(2200, ctx.currentTime); // Higher pitch
        
        // Sharp envelope
        gain.gain.setValueAtTime(0.8, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1); // Fast decay
        
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
    }

    function createCabinetGrid() {
        const grid = document.getElementById('cabinetGrid');
        
        cabinetDataRaw.forEach((data, index) => {
            const cell = document.createElement('div');
            
            if (data.type === 'safe') {
                cell.className = 'cell decoration';
                cell.innerHTML = `<svg class="decoration-icon" viewBox="0 0 100 100" fill="none" stroke="#34495e" stroke-width="4">
                    <rect x="15" y="15" width="70" height="70" rx="5" fill="#ecf0f1"/>
                    <circle cx="50" cy="50" r="12" fill="#bdc3c7" stroke="#7f8c8d"/>
                    <circle cx="65" cy="50" r="2" fill="#2c3e50"/>
                    <path d="M50 38 L50 30" stroke="#7f8c8d"/>
                </svg>`;
            } else if (data.type === 'empty' && data.balls.length === 0) {
                cell.className = 'cell empty';
            } else {
                cell.className = 'cell';

                // Calculate correct letter for this cell
                const morseStr = data.balls.map(num => getSymbol(num)).join('');
                const correctLetter = symbolToLetterMap[morseStr] || "";

                // Letter Input
                const input = document.createElement('input');
                input.className = 'letter-board';
                input.maxLength = 1;
                input.dataset.correct = correctLetter; // Store correct answer
                
                // Validation and Sync
                input.addEventListener('input', function() {
                    // Validation logic
                    const val = this.value.toUpperCase();
                    if (val && val !== this.dataset.correct) {
                        this.style.color = '#e74c3c'; // Red color for incorrect
                    } else {
                        this.style.color = '#2c3e50'; // Default color
                    }
                    // Sync
                    syncLetters(index);
                });

                cell.appendChild(input);

                // Symbol Board
                const symbolBoard = document.createElement('div');
                symbolBoard.className = 'symbol-board';
                
                const ballsContainer = document.createElement('div');
                ballsContainer.className = 'balls-container';
                
                // Special layout for 4 balls: 2x2 grid
                if (data.balls.length === 4) {
                    ballsContainer.classList.add('wrap-grid');
                }

                data.balls.forEach((num, ballIndex) => {
                    const symbolPlaceholder = document.createElement('div');
                    symbolPlaceholder.className = 'symbol-placeholder';
                    symbolPlaceholder.id = `symbol-${index}-${ballIndex}`;
                    symbolPlaceholder.onclick = () => toggleLeftSymbol(index, ballIndex, symbolPlaceholder);
                    symbolBoard.appendChild(symbolPlaceholder);

                    const ball = document.createElement('div');
                    ball.className = 'ball';
                    ball.textContent = num;
                    ball.onclick = () => {
                        toggleLeftSymbol(index, ballIndex, symbolPlaceholder);
                    };
                    ballsContainer.appendChild(ball);
                });

                cell.appendChild(symbolBoard);
                cell.appendChild(ballsContainer);
            }
            grid.appendChild(cell);
        });
    }

    // Sync Logic: Aggregates letters from left inputs to right input
    function syncLetters(changedCellIndex) {
        const layerIndex = Math.floor(changedCellIndex / 6);
        const startCell = layerIndex * 6;
        const endCell = startCell + 6;
        
        let word = "";
        const inputs = document.querySelectorAll('.letter-board');
        
        let inputCounter = 0;
        const dataToInputMap = {}; // Maps data index to input element index
        
        cabinetDataRaw.forEach((d, idx) => {
            if (!d.type && d.balls.length > 0) {
                dataToInputMap[idx] = inputCounter++;
            }
        });

        for (let i = startCell; i < endCell; i++) {
            if (dataToInputMap.hasOwnProperty(i)) {
                const inputIdx = dataToInputMap[i];
                if (inputs[inputIdx]) {
                    word += inputs[inputIdx].value.toUpperCase();
                }
            }
        }
        
        document.getElementById(`input-word-${layerIndex}`).value = word;
    }

    // Initialize Right Sidebar Interactive Boards
    function initSidebarInteractiveBoards() {
        for (let layer = 0; layer < 5; layer++) {
            const board = document.getElementById(`sidebar-board-${layer}`);
            
            // Always 1 button per layer
            const buttonCount = 1;
            
            for (let i = 0; i < buttonCount; i++) {
                const uniqueId = `sidebar-${layer}-${i}`;
                const placeholder = document.createElement('div');
                placeholder.className = 'symbol-placeholder';
                placeholder.onclick = () => toggleRightSymbol(uniqueId, placeholder);
                board.appendChild(placeholder);
            }
        }
    }

    function toggleLeftSymbol(cellIndex, ballIndex, element) {
        playClickSound(); // Add sound
        const key = `${cellIndex}-${ballIndex}`;
        let current = ballStates[key];

        if (current === 'dot') {
            ballStates[key] = 'dash';
            element.className = 'morse-dash';
            element.style.backgroundColor = ''; 
            element.title = "è³ªæ•¸ (Prime)";
        } else if (current === 'dash') {
            ballStates[key] = null;
            element.className = 'symbol-placeholder';
            element.style.backgroundColor = '#95a5a6';
            element.title = "";
        } else {
            ballStates[key] = 'dot';
            element.className = 'morse-dot';
            element.style.backgroundColor = '';
            element.title = "åˆæ•¸ (Composite)";
        }
    }

    function toggleRightSymbol(id, element) {
        playClickSound(); // Add sound
        let current = sidebarStates[id];

        if (current === 'dot') {
            sidebarStates[id] = 'dash';
            element.className = 'morse-dash';
            element.style.backgroundColor = ''; 
        } else if (current === 'dash') {
            sidebarStates[id] = null;
            element.className = 'symbol-placeholder';
            element.style.backgroundColor = '#95a5a6';
        } else {
            sidebarStates[id] = 'dot';
            element.className = 'morse-dot';
            element.style.backgroundColor = '';
        }
    }

    function createMorseTable() {
        const table = document.getElementById('morseTable');
        
        const sortedKeys = Object.keys(morseCodeMap).sort((a, b) => {
            const isNumA = /^\d$/.test(a);
            const isNumB = /^\d$/.test(b);
            if (isNumA && !isNumB) return 1;
            if (!isNumA && isNumB) return -1;
            return a.localeCompare(b);
        });

        let addedSeparator = false;

        sortedKeys.forEach(key => {
            if (/^\d$/.test(key) && !addedSeparator) {
                const separator = document.createElement('div');
                separator.className = 'morse-separator';
                table.appendChild(separator);
                addedSeparator = true;
            }

            const val = morseCodeMap[key];
            const item = document.createElement('div');
            item.className = 'morse-item';
            
            let visualHtml = '<div class="morse-visual">';
            for (let char of val) {
                if (char === '.') {
                    visualHtml += '<div class="table-dot"></div>';
                } else {
                    visualHtml += '<div class="table-dash"></div>';
                }
            }
            visualHtml += '</div>';

            item.innerHTML = `<span>${key}</span>${visualHtml}`;
            table.appendChild(item);
        });
    }

    // Modal Control Functions
    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('resultModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Sound Effects using Web Audio API
    function playSuccessSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const now = ctx.currentTime;

        // create white noise buffer for paper texture
        const bufferSize = ctx.sampleRate * 2; // 2 seconds buffer
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }

        // Function to simulate one bill flip (swish sound)
        function playBillFlip(time) {
            const source = ctx.createBufferSource();
            source.buffer = buffer;

            // Filter: Lower frequency for a "thicker/lower" paper sound
            const filter = ctx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 600 + Math.random() * 400; // Lowered from 1200+
            filter.Q.value = 1.0; // Slightly sharper resonance

            const gain = ctx.createGain();
            // Envelope: Sharp attack, fast decay
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(1.0, time + 0.005); // Faster attack
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.06); // Faster decay

            source.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);

            source.start(time);
            source.stop(time + 0.1);
        }

        // Play a sequence: Faster speed
        const billCount = 15; // More bills
        const speed = 0.05; // Faster interval (was 0.09)
        
        for (let i = 0; i < billCount; i++) {
            playBillFlip(now + i * speed + Math.random() * 0.01);
        }

        // "Ca-ching!" - Crisper, higher pitch
        const endTime = now + billCount * speed + 0.1;
        
        // 1. Main Ding (Triangle wave for metallic crispness)
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(3500, endTime); // Higher start pitch
        osc.frequency.exponentialRampToValueAtTime(3500, endTime + 0.5); // Steady pitch for clarity
        
        gain.gain.setValueAtTime(0, endTime);
        gain.gain.linearRampToValueAtTime(0.5, endTime + 0.01); // Sharp attack
        gain.gain.exponentialRampToValueAtTime(0.001, endTime + 1.5); // Long ringing tail
        
        osc.start(endTime);
        osc.stop(endTime + 1.5);

        // 2. Sparkle overlay (High Sine)
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(5000, endTime);
        
        gain2.gain.setValueAtTime(0, endTime);
        gain2.gain.linearRampToValueAtTime(0.2, endTime + 0.01);
        gain2.gain.exponentialRampToValueAtTime(0.001, endTime + 0.3); // Short sparkle
        
        osc2.start(endTime);
        osc2.stop(endTime + 0.3);
    }

    function playErrorSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sawtooth'; 
        
        const now = ctx.currentTime;
        const duration = 3.0; // 3 seconds

        // Siren wail: Low frequency 150-400Hz
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(400, now + 0.5);
        osc.frequency.linearRampToValueAtTime(150, now + 1.0);
        osc.frequency.linearRampToValueAtTime(400, now + 1.5);
        osc.frequency.linearRampToValueAtTime(150, now + 2.0);
        osc.frequency.linearRampToValueAtTime(400, now + 2.5);
        osc.frequency.linearRampToValueAtTime(150, now + 3.0);

        // Volume envelope
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.setValueAtTime(0.2, now + duration - 0.5);
        gain.gain.linearRampToValueAtTime(0, now + duration);
        
        osc.start(now);
        osc.stop(now + duration);
    }

    function checkAnswer() {
        let allCorrect = true;
        let errorMsg = [];
        const modalMessage = document.getElementById('modalMessage');
        const modal = document.getElementById('resultModal');

        // Check 5 layers
        for (let i = 0; i < 5; i++) {
            const numInput = document.getElementById(`input-num-${i}`);
            const val = parseInt(numInput.value);
            
            if (isNaN(val) || val !== correctAnswers[i]) {
                allCorrect = false;
                errorMsg.push(`ç¬¬ ${i+1} å±¤`);
                numInput.style.borderColor = '#e74c3c';
                numInput.style.backgroundColor = '#fadbd8';
            } else {
                numInput.style.borderColor = '#27ae60';
                numInput.style.backgroundColor = '#d5f5e3';
            }
        }

        // Check final key
        const finalKeyInput = document.getElementById('final-key-input');
        const finalKeyVal = parseInt(finalKeyInput.value);
        
        if (isNaN(finalKeyVal) || finalKeyVal !== correctFinalKey) {
             allCorrect = false;
             errorMsg.push("æ­£ç¢ºé‘°åŒ™ç·¨è™Ÿ");
             finalKeyInput.style.borderColor = '#e74c3c';
             finalKeyInput.style.backgroundColor = '#fadbd8';
        } else {
             finalKeyInput.style.borderColor = '#27ae60';
             finalKeyInput.style.backgroundColor = '#d5f5e3';
        }

        if (allCorrect) {
            playSuccessSound(); // Play unlock sound
            modalMessage.innerHTML = `
                <img src="win.png" style="max-width: 200px; height: auto; margin-bottom: 15px;" alt="å‹åˆ©">
                <div class="modal-title success-style">ğŸ‰ ä»»å‹™æˆåŠŸï¼<br>ç»ç’ƒæ«ƒå·²é–‹å•Ÿï¼Œè«‹ç‰¹å‹™åŠ å¿«é€Ÿåº¦å¥ªå›ç å¯¶ï¼</div>
            `;
            // ç¦ç”¨æŒ‰éˆ•é¿å…é‡è¤‡æäº¤
            const btn = document.querySelector('.submit-btn');
            btn.disabled = true;
            btn.style.backgroundColor = '#95a5a6';
            btn.style.cursor = 'default';
            btn.innerText = "ä»»å‹™å·²å®Œæˆ";
        } else {
            playErrorSound(); // Play siren sound
            modalMessage.innerHTML = `
                <img src="lose.png" style="max-width: 200px; height: auto; margin-bottom: 15px;" alt="å¤±æ•—">
                <div class="modal-title error-style">ğŸš¨ è­¦å ±éŸ¿èµ·ï¼Œä»»å‹™å¤±æ•—ï¼å®ˆè¡›æ­£åœ¨é€¼è¿‘ï¼</div>
                <div class="modal-text">éŒ¯èª¤ä½ç½®ï¼š${errorMsg.join(", ")}</div>
            `;
        }
        
        modal.style.display = 'flex';
    }

    initGame();
</script>

</body>
</html>
